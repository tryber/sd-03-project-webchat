<!DOCTYPE html>
<html>
  <head>
    <title>SlackWebChat</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script>
      const socket = io(); // Executa uma conexão com localhost:3000
      let nickname = 'Anonnnnymous';
      let oldname = '';
      let userlist = [];
      let chatMessage = '';

      const appendMsg = (msg, isChatMsg) => {
        $('.messages')
          .append(
            $(isChatMsg
            ? '<li data-testid="message">'
            : '<li class="chat-event">')
            .text(msg));
      }

      const manageUserList = () => {
        $('.user-list').empty();
          userlist.map((u) => 
            $('.user-list').append($('<li>').text(u)));
      }
      
      // Alternativa ao document.ready
      $(() => {
        
        // ----- Eventos para enviar pacotes ----- \\
        // Alteração do nickname
        $('#nickname-save').click(() => {
          oldname = nickname;
          nickname = $('#nickname-box').val();
          appendMsg(`${oldname} alterou o nick para ${nickname}`);
          socket.emit('userRename', { oldname, nickname, userlist });
          $('.nickname').text(nickname);
          $('#messageInput').val('');
        });
        
        // Envio da mensagem
        $('#send-button').click((e) => {
          chatMessage = $('#messageInput').val();
          socket.emit('message', { nickname, chatMessage });
          $('#messageInput').val('');
        });
        
        // ----- Eventos de pacotes recebidos ----- \\
        // Carregamento das mensagens do banco
        socket.on('loadHistory', (messages) => {
          messages.map(({
            nickname,
            chatMessage,
            currTime
          }) => appendMsg(`(${currTime}) - ${nickname}: ${chatMessage}`, true));
        });

        socket.on('getUserList', (users) => {
          userlist = users;
        });

        // Notificação de que usuário ingressou na sala
        socket.on('newUserMsg', (user) => {
          nickname = user;
          userlist.push(user);
          appendMsg(`${user} ingressou na sala`);
          manageUserList();
        });
        
        // Notificação de usuário que renomeou o nick
        socket.on('userRename', (newList) => {
          manageUserList(newList);
        });
        
        // Recebimento de mensagem padrão
        socket.on('message', (string) => {
          appendMsg(string, true);
        })

        // Alguém saiu da sala
        socket.on('userLogOff', ({mensagem}) =>
          appendMsg(mensagem));

        // O próprio cliente se desconectou
        socket.on('disconnect', ({mensagem}) =>
          appendMsg(mensagem));
      });

    </script>
  </head>
  <body>
    <div class="messages">
      <h2>Mensagens</h2>
    </div>
    <div class="userPanel">
      <h2>Usuários conectados</h2>
      <ul class="user-list"></ul>
      <div class="nickname-form">
        <h3>Você está conectado como 
          <span data-testid="online-user" class="nickname">anonymous</span>.
        </h3>
        <input id="nickname-box" data-testid="nickname-box" />
        <button id="nickname-save" data-testid="nickname-save">
          Alterar nick
        </button>
      </div>
    </div>
    <div class="message-box">
      <input
        id="messageInput"
        autocomplete="off"
        data-testid="message-box"
      />
      <button
        type="submit"
        id="send-button"
        data-testid="send-button"
      >
        Enviar
      </button>
    </div class="message-box">
  </body>
</html>