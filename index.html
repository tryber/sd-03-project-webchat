<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO - trybe</title>
    <link type="text/css" rel="stylesheet" href="/index.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script>
      $(function () {
        const socket = io();

        let privateMode = false;
        let recipientId = '';

        //gera nick aleatório e cadastra no DB
        const randomNum = Math.floor(Math.random() * 100000);
        let nickname = `random${randomNum}`;
        $('#nick-input').attr('placeholder', nickname);
        socket.emit('registerNick', { nickname });

        //função do botao de mudar nick
        $('#nick-form').submit(function(e) {
          e.preventDefault();
          nickname = $('#nick-input').val();
          socket.emit('registerNick', { nickname });
          return false;
        });

        //cria elemento mensagem
        const createMessageElement = (message) => {
          const messageLi = document.createElement('li');
          messageLi.setAttribute('data-testid','message')
          const messageText = document.createTextNode(message);
          messageLi.appendChild(messageText);
          $('#messages').append(messageLi);
        }

        //cria elemento usuarios na lista
        const createUserItem = (nickname) => {
          const mainUserListDiv = document.createElement('div');
          
          const userLi = document.createElement('li');
          userLi.setAttribute('data-testid','online-user')
          userLi.setAttribute('class','user-list-item')
          const userText = document.createTextNode(nickname);
          userLi.appendChild(userText);
          mainUserListDiv.appendChild(userLi);
          
          //cria botões de chat público ou reservado
          const chatButtonsDiv = document.createElement('div');
          chatButtonsDiv.setAttribute('class', 'private-public-buttons-div');

          const privateChatButton = document.createElement('button');
          const privateChatButtonContent = document.createTextNode('R')
          privateChatButton.appendChild(privateChatButtonContent);
          privateChatButton.setAttribute('class', 'private-chat-button');
          privateChatButton.setAttribute('id', `private-chat-button-${nickname}`);
          privateChatButton.setAttribute('data-testid', 'private');

          const publicChatButton = document.createElement('button');
          const publicChatButtonContent = document.createTextNode('P')
          publicChatButton.appendChild(publicChatButtonContent);
          publicChatButton.setAttribute('class', 'public-chat-button');
          publicChatButton.setAttribute('data-testid', 'public');

          chatButtonsDiv.appendChild(privateChatButton);
          chatButtonsDiv.appendChild(publicChatButton);

          //adiciona botões e item na lista
          mainUserListDiv.appendChild(chatButtonsDiv)

          $('#user-list').append(mainUserListDiv);
        }

        //cria lista de usuarios
        const createUserList = (users) => {
          $('#user-list').empty();
          users.forEach(({ nickname }) => createUserItem(nickname))
        };

        //obtem lista de mensagens
        const retrieveMessages = ({ history }) => history.length > 0
          ? history.forEach((message) => createMessageElement(message))
          : null;

        //obtem histórico de mensagens
        socket.on('history', (history) => retrieveMessages(history));

        //atualiza lista de usuarios
        socket.on('userList', ({ users }) => createUserList(users));

        //função do botao de enviar mensagem
        $('#chat-form').submit(function(e) {
          e.preventDefault();
          if(!privateMode) {
            socket.emit('message', { chatMessage: $('#chat-input').val(), nickname });
            $('#chat-input').val('');
            return null;
          }
          socket.emit('privateMessage', { privateRecipient: recipientId, chatMessage: $('#chat-input').val(), nickname });
          $('#chat-input').val('');
        });

        //reage ao evento messageServer e envia mensagens para todos os clientes
        socket.on('message', function(message){
          createMessageElement(message);
        });

        $(document).on('click', '.private-chat-button', (event) => {
          // const privateChatRecipient = $(this).text();
          const recipientNickname = event.target.id.substr(20)
          if (recipientNickname === nickname) return console.log('Você não pode entrar em chat reservado consigo mesmo.');
          socket.emit('triggerPrivateChat', { from: nickname, to: recipientNickname });
        })

        $(document).on('click', '.public-chat-button', () => {
          socket.emit('triggerPublicChat', { recipientId });
        })
        
        socket.on('allowPrivateMode', ({ privateUserId }) => {
          console.log('private mode allowed')
          privateMode = true;
          recipientId = privateUserId;
        });

        socket.on('allowPublicMode', () => {
          console.log('public mode allowed')
          privateMode = false;
          recipientId = '';
        });
      });
    </script>
  </head>
  <body>
    <div class="master-container">
      <div class="messages-user-container">
        <div class="message-div">
          <ul id="messages"></ul>
        </div>
        <div class="user-div">
          <ul id="user-list"></ul>
        </div>
      </div>
      <div class="input-container">
        <form id="nick-form" action="" >
          <span style="color: white">NICKNAME: </span>
          <input id="nick-input" data-testid="nickname-box" style="max-width: 120px" placeholder="random" />
          <button data-testid="nickname-save">SALVAR</button>
        </form>
        <form id="chat-form" action="">
          <input id="chat-input" data-testid="message-box" autocomplete="off" /><button data-testid="send-button">Send</button>
        </form>
      </div>
    </div>
  </body>
</html>
