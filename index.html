<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Webchat</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <!--Pegar os elemtnos do html e salvar numa var pra manipular-->
  <ul class="chat" id="chat"></ul>
  <form>
    <input
      autocomplete="off"
      id="chatInput"
      class="chatInput"
      data-testid="message-box"
      type="text"
    />
    <button
      class="sendButton"
      data-testid="send-button"
      id="sendButton"
    >
    Enviar
    </button>
    <input
      autocomplete="off"
      id="nickInput"
      class="nickInput"
      data-testid="nickname-box"
      type="text"
    />
    <button
      class="nickButton"
      data-testid="nickname-save"
      id="nickButton"
    >
    Enviar
    </button>
  </form>
  <ul class="onlineList" id="onlineList"></ul>
  <script>
    // Pegar todos os elementos e salvar
    const chatList = document.getElementById('chat');
    const onlineList = document.getElementById('onlineList');
    const sendButton = document.getElementById('sendButton');
    const nickButton = document.getElementById('nickButton');
    const socket = io();

    let nickname = '';

    // Cria uma mensagem e joga ela na lista
    const createMessage = (message, list) => {
      const msg = document.createElement('li');
      msg.textContent = message;
      msg.setAttribute('data-testid', 'message')
      list.appendChild(msg);
    };

    const generateRndNick = () => {
      // adaptado da primeira resposta deste link
      // https://stackoverflow.com/questions/1349404/generate-random-string-characters-in-javascript
      const nickname = [];
      const chars = 'abcdefghijklmnopqrstuvwxyz';
      const charsLen = 26;
      for (let i = 0; i < 6; i += 1) {
        nickname.push(chars.charAt(Math.floor(Math.random() * charsLen)));
      }
      return nickname.join('');
    };

    socket.on('message', (message) => {
      return createMessage(message, chatList);
    });

    socket.on('history', (messages) => {
      return messages.forEach(({ message }) => createMessage(message, chatList));
    });

    socket.on('allOnline', (users) => {
      // Vai sempre ser emitido pelo server quando houver conexão e desconexão
      return users.forEach(({ nickname }) => {
        const li = document.createElement('li');
        li.textContent = nickname;
        li.setAttribute('data-testid', 'online-user');
        onlineList.appendChild(li);
      });
    });

    socket.on('onlineUsers', (users) => {
      console.log(users)
      onlineList.innerHTML = '';
      return users.forEach(({ nickname }) => {
        const li = document.createElement('li');
        li.textContent = nickname;
        li.setAttribute('data-testid', 'online-user');
        onlineList.appendChild(li);
      });
    });

    // adiciona os ouvidores de eventos
    sendButton.addEventListener('click', (event) => {
      event.preventDefault();
      const chatMessage = document.getElementById('chatInput').value;
      return socket.emit('message', { chatMessage, nickname });
    });
    nickButton.addEventListener('click', (event) => {
      event.preventDefault()
      const newNick = document.getElementById('nickInput').value;
      socket.emit('nickname', { prevNick: nickname, nickname: newNick });
      nickname = newNick;
    });

    window.onload = () => {
      nickname = generateRndNick();
      socket.emit('nickname', { prevNick: null, nickname });
    };
  </script>
</body>
</html>
