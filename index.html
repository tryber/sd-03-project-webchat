<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO - trybe</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font: 13px Helvetica, Arial;
      }
      form {
        background: #000;
        padding: 3px;
        position: fixed;
        bottom: 0;
        width: 100%;
      }
      form input {
        border: 0;
        padding: 10px;
        width: 90%;
        margin-right: 0.5%;
      }
      form button {
        width: 9%;
        background: rgb(130, 224, 255);
        border: none;
        padding: 10px;
        cursor: pointer;
      }
      #messagens {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }
      #messagens li {
        padding: 5px 10px;
      }
      #messagens li:nth-child(odd) {
        background: #eee;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <body>
    <input type="text" name="" id="nickname", data-testid="nickname-box">
    <button 
      type="button"  
      data-testid="send-button"
      id='sendButton'
    > Save name
    </button>
    <ul id="messagens"></ul>
    <form action="">
      <input id="mensagemInput" autocomplete="off" data-testid="message-box" />
      <button data-testid="send-button">Send</button>
    </form>
    <script>
      const form = document.querySelector('form');
      const messageInput = document.querySelector('#mensagemInput');
      const messagens = document.querySelector('#messagens');
      const sendButton = document.getElementById('sendButton');
      const nicknameElement = document.getElementById('nickname');

      const createChatMessage = (message) => {
        const li = document.createElement('li');

        li.setAttribute('data-testid', 'message')
        li.innerHTML = `
          <p className='dateOnMessage'>${message}</p>
        `;

        messagens.appendChild(li);
      }

      const socket = io(); /* 'http://localhost:3000' */
      
      socket.on('history', (messages) => {
        messages.forEach((message) => createChatMessage(message)
)
      })

      let nickname = 'not a random name';

      sendButton.onclick = () => {
        nickname = nicknameElement.value;
      };

      const randomName = fetch('https://randomuser.me/api/').then(
        async (data) => {
          const json =  await data.json()
          const { results: [{ name: { title, first, last } }]} = await json;
          const name = await `${title} ${first} ${last}`
          nickname = name;
          nicknameElement.value = nickname;
        })

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const message = { 
          chatMessage: messageInput.value,
          nickname,
        }
        socket.emit('message', message);
        messageInput.value = '';
      });

      socket.on('mensagemServer', (message) => createChatMessage(message));

      socket.on('disconnect', () => ({ nickname }));
    </script>
  </body>
</html>
