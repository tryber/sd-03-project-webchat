<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO - trybe</title>
    <link type="text/css" rel="stylesheet" href="/index.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script>
      $((
      ) => {
        const socket = io();

        let privateMode = false;
        let recipientId = '';

        //gera nick aleatório e cadastra no DB
        const randomNum = Math.floor(Math.random() * 100000);
        let nickname = `random${randomNum}`;
        $('#nick-input').attr('placeholder', nickname);
        socket.emit('registerNick', { nickname });


        //cria elemento mensagem
        const createMessageElement = (message) => {
          const messageLi = $('<li>').prop('data-testid','message').text(message);
          $('#messages').append(messageLi);
        }

        //cria elemento usuarios na lista
        const createUserItem = (nickname) => {
          const mainUserListDiv = $('<div>');

          const userListItem = $('<li>')
            .prop({ 'data-testid': 'online-user', 'class': 'user-list-item' })
            .text(nickname);

          mainUserListDiv.append(userListItem);
          
          //cria botões de chat público ou reservado
          const chatButtonsDiv = $('<div>').prop('class', 'private-public-buttons-div');

          const privateChatButton = $('<button>').prop({
            'class': 'private-chat-button',
            'id': `private-chat-button-${nickname}`,
          })
          .attr('data-testid', 'private')
          .text('Reserv.');

          const publicChatButton = $('<button>').prop({
            'class': 'public-chat-button',
            'id': `public-chat-button-${nickname}`,
          })
          .attr('data-testid', 'public')
          .text('Público');

          chatButtonsDiv.append(privateChatButton);
          chatButtonsDiv.append(publicChatButton);

          //adiciona botões e item na lista
          mainUserListDiv.append(chatButtonsDiv)

          $('#user-list').append(mainUserListDiv);
        }

        //cria lista de usuarios
        const createUserList = (users) => {
          $('#user-list').empty();
          users.forEach(
            ({ nickname }) => {
              createUserItem(nickname)
          })
        };

        //obtem lista de mensagens
        const retrieveMessages = (history) => history.length > 0
        ? history.forEach((message) => createMessageElement(message))
        : null;

        //função do botao de mudar nick
        $('#nick-form').submit(
          (e) => {
          e.preventDefault();
          nickname = $('#nick-input').val();
          socket.emit('registerNick', { nickname });
          return false;
        });

        //função do botao de enviar mensagem
        $('#chat-form').submit(
          (e) => {
          e.preventDefault();
          if(!privateMode) {
            socket.emit('message', { chatMessage: $('#chat-input').val(), nickname });
            $('#chat-input').val('');
            return null;
          }
          
          socket.emit('privateMessage', { recipientId, chatMessage: $('#chat-input').val(), nickname });
          $('#chat-input').val('');
        });

        $(document).on('click', '[data-testid=private]',
        (event) => {
          // const privateChatRecipient = $(this).text();
          const recipientNickname = event.target.id.substr(20)
          if (recipientNickname === nickname) return console.log('Você não pode entrar em chat reservado consigo mesmo.');
          $('#messages').empty();

          socket.emit('triggerPrivateChat', { from: nickname, to: recipientNickname });
        })

        $(document).on('click', '[data-testid=public]', (
        ) => {
          $('#messages').empty();
          socket.emit('triggerPublicChat', { recipientId });
        })

        //obtem histórico de mensagens
        socket.on('history', ({ history }) => retrieveMessages(history));

        //atualiza lista de usuarios
        socket.on('userList', ({ users }) => createUserList(users));

        //reage ao evento messageServer e envia mensagens para todos os clientes
        socket.on('message', (
          message) => {
          console.log(message)
          createMessageElement(message);
        });


        socket.on('clearChat', () => $('#messages').empty());
        
        socket.on('allowPrivateMode', (
          { recipientId: currentRecipientId }) => {
          console.log('private mode allowed')
          // console.log(`private recipient*: ${currentRecipientId}`)

          privateMode = true;
          recipientId = currentRecipientId;
        });

        socket.on('retrieveSecretHistory', (
          { secretHistory }) => {
          console.log(`secret history: ${secretHistory}`)

          retrieveMessages(secretHistory)
        });

        socket.on('allowPublicMode', (
        ) => {
          console.log('public mode allowed')
          privateMode = false;
          recipientId = '';
        });
      });
    </script>
  </head>
  <body>
    <div class="master-container">
      <div class="messages-user-container">
        <div class="message-div">
          <ul id="messages"></ul>
        </div>
        <div class="user-div">
          <ul id="user-list"></ul>
        </div>
      </div>
      <div class="input-container">
        <form id="nick-form" action="" >
          <span style="color: white">NICKNAME: </span>
          <input id="nick-input" data-testid="nickname-box" style="max-width: 120px" placeholder="random" />
          <button data-testid="nickname-save">SALVAR</button>
        </form>
        <form id="chat-form" action="">
          <input id="chat-input" data-testid="message-box" autocomplete="off" />
          <button data-testid="send-button">Send</button>
        </form>
      </div>
    </div>
  </body>
</html>
