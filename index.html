<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO - webchat</title>
    <style>
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    </script>
  </head>
  <body>
    <form>
      <input type="text" id="nickname-box" data-testid="nickname-box"/>
      <button id="nickname-save" data-testid="nickname-save" type="button">SAVE</button>
    </form>
    <div id="messagens-history"></div>
    <form>
      <input type="text" id="message-box" data-testid="message-box"/>
      <button id="send-button" data-testid="send-button" type="button">SEND</button>
    </form>
    <ul data-testid="online-container" id="online-container"></ul>
  </body>
  <script>
    const socket = io('http://localhost:3000')
    let sendMessage = document.getElementById('send-button');
    let changeNick = document.getElementById('nickname-save');

    const randomUserName = () => {
      const randomNumber = parseInt(Math.random() * 100000 );
      const newUserNick = `User${randomNumber}`;
      socket.emit("newUser", newUserNick);
      return newUserNick;
    };
    
    let username = randomUserName();

    socket.on('onlineList', (arrUsers) => {
      const parent = document.getElementById('online-container')
      while (parent.firstChild) {
        parent.firstChild.remove()
      }
      arrUsers.forEach((elem) => {
        const li = document.createElement('li');
        li.setAttribute("data-testid", "online-user");
        li.textContent = elem.nickname;
        document.getElementById('online-container').appendChild(li);
      })
    });

    socket.on('message', (newMessage) => {
      const p = document.createElement('p');
      p.setAttribute("data-testid", "message");
      p.textContent = newMessage;
      document.getElementById('messagens-history').appendChild(p);
    });

    socket.on('history', (arrMessage) => {
      arrMessage.forEach(({msgDate, msgTime, nickname, chatMessage}) => {
        const message = `${msgDate} ${msgTime} - ${nickname}: ${chatMessage}`;
        const p = document.createElement('p');
        p.setAttribute("data-testid", "message");
        p.textContent = message;
        document.getElementById('messagens-history').appendChild(p);
      })
    });

    sendMessage.addEventListener('click',function() {
      const message = document.getElementById('message-box');
      socket.emit("message", { chatMessage: message.value , nickname: username });
      message.value = '';
    });

    changeNick.addEventListener('click',function() {
      let newNick = document.getElementById("nickname-box");
      username = newNick.value;
      socket.emit("changeNick", username);
      newNick.value = '';
    });
   </script>
</html>