<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zap Efron</title>
    <link rel="stylesheet" type="text/css" href="./style.css" media="screen" />
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div id="app-content">
      <div id="header">
        <h1>Zap Efron</h1>
      </div>
      <div id="user-content">
        <div id="user-photo"></div>
        <div id="nickname"></div>
        <form id="form-nickname">
          <input
            id="nickname-box"
            placeholder="Me chame de..."
            data-testid="nickname-box"
          />
          <button id="nickname-save" data-testid="nickname-save">Salvar</button>
        </form>
      </div>
      <div id="chat-content">
        <div>
          <ul id="ul-messages"></ul>
        </div>
        <div>
          <form id="form-message">
            <input
              id="message-box"
              placeholder="Digite uma mensagem..."
              data-testid="message-box"
            />
            <button type="submit" id="send-button" data-testid="send-button">
              Enviar
            </button>
          </form>
        </div>
      </div>
    </div>
  </body>
  <script defer>
    const socket = io('http://localhost:3000');

    const formMessage = document.getElementById('form-message');
    const messageBox = document.getElementById('message-box');
    const formNickname = document.getElementById('form-nickname');
    const nicknameBox = document.getElementById('nickname-box');
    const userNickname = document.getElementById('nickname');

    const selfJoin = ({ nickname }) => {
      const li = document.createElement('li');

      userNickname.textContent = nickname;

      li.textContent = `Você entrou no chat`;
      li.classList = 'joined message';

      document.getElementById('ul-messages').appendChild(li);
    };

    const joinedChat = ({ nickname }) => {
      const li = document.createElement('li');

      li.textContent = `${nickname} entrou no chat`;
      li.classList = 'joined message';

      document.getElementById('ul-messages').appendChild(li);
    };

    const sendMessage = (event) => {
      event.preventDefault();

      const date = new Date(Date.now()).toLocaleString();

      const chatMessage = `${date}: ${messageBox.value}`;
      const nickname = userNickname.textContent;

      messageBox.value = '';

      socket.emit('message', { chatMessage, nickname });
    };

    const receivedMessage = ({ chatMessage, nickname }) => {
      const li = document.createElement('li');

      li.textContent = `${nickname} - ${chatMessage}`;
      li.setAttribute('data-testid', 'message');
      li.classList = 'message';

      document.getElementById('ul-messages').appendChild(li);
    };

    const sendNameUpdate = (event) => {
      event.preventDefault();

      const nickname = userNickname.textContent;
      const newName = nicknameBox.value;

      nicknameBox.value = '';

      socket.emit('change-name', { nickname, newName });
    };

    const updateName = ({ newName }) => {
      userNickname.textContent = newName;
    };

    const someoneUpdatedName = ({ nickname, newName }) => {
      const li = document.createElement('li');

      li.textContent = `${nickname} agora é ${newName}`;
      li.classList = 'joined message';

      document.getElementById('ul-messages').appendChild(li);
    };

    formMessage.addEventListener('submit', (e) => sendMessage(e));

    formNickname.addEventListener('submit', (e) => sendNameUpdate(e));

    socket.on('self-join', (data) => selfJoin(data));

    socket.on('joined', (data) => joinedChat(data));

    socket.on('message', (data) => receivedMessage(data));

    socket.on('change-name', (data) => updateName(data));

    socket.on('someone-change-name', (data) => someoneUpdatedName(data));
  </script>
</html>
