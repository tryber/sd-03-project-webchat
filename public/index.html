<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bate-papo Trybol</title>
  </head>

  <body>
    <input type="text" name="" id="username" data-testid="nickname-box">
    <button id="user-save" data-testid="nickname-save">Salvar Apelido</button>
    <h4 id="name"></h4>
    <ul id="chat"></ul>
    <input type="text" name="" id="user-message" data-testid="message-box">
    <button id="send-msg" data-testid="send-button">Enviar</button>
    <div>
      <ul id="online-users"></ul>
    </div>
    <button id="private-chat-btn" data-testid="private">Chat Privado</button>
    <button data-testid="public"> Chat Publico</button>
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io('http://localhost:3000');

    const nickname = document.getElementById('username');
    const saveUserName = document.getElementById('user-save');
    const sendChatMessage = document.getElementById('send-msg');
    const privateChatButton = document.getElementById('private-chat-btn');
    const chatMessage = document.getElementById('user-message');

    nickname.addEventListener('keyup', () => {
      if (nickname.value === '') {
        saveUserName.disabled = true;
      } else {
        saveUserName.disabled = false;
      }
    });

    chatMessage.addEventListener('keyup', () => {
      if (chatMessage.value === '') {
        sendChatMessage.disabled = true;
      } else {
        sendChatMessage.disabled = false;
      }
    });

    saveUserName.addEventListener('click', () => {
      const name = document.getElementById('name');
      name.textContent = `Name: ${nickname.value}`;
      socket.emit('user-nickname', { nickname: nickname.value });
      nickname.value = '';
      if (nickname.value === '') saveUserName.disabled = true;
    });

    sendChatMessage.addEventListener('click', () => {
      const nickname = document.getElementById('name').textContent.split(' ')[1];
      socket.emit('message', { chatMessage: chatMessage.value, nickname });
      chatMessage.value = '';
      if (chatMessage.value === '') sendChatMessage.disabled = true;
    });

    privateChatButton.addEventListener('click', () => {
      const list = document.getElementById('chat');
      if (list.childNodes.length === 1) return;
      list.removeChild(list.childNodes[0]);
    });

    socket.on('messages-history', (allMsg) => {
      allMsg.forEach(({ date, nickname, message }) => {
        const li = document.createElement('li');
        li.textContent = `${date} - ${nickname} => ${message}`;
        li.setAttribute('data-testid', 'message');
        document.getElementById('chat').appendChild(li);
      });
    });

    socket.on('online-users', (data) => {
      data.forEach(({ name }) => {
        const li = document.createElement('li');
        li.textContent = name;
        li.setAttribute('data-testid', 'online-user');
        document.getElementById('online-users').appendChild(li)
      });
    });

    socket.on('new-online-user', (name) => {
      const li = document.createElement('li');
      li.textContent = name;
      li.setAttribute('data-testid', 'online-user');
      document.getElementById('online-users').appendChild(li)
    });

    socket.on('new-online-list', (data) => {
      document.getElementById('online-users').textContent = '';
      data.forEach(({ name }) => {
        const li = document.createElement('li');
        li.textContent = name;
        document.getElementById('online-users').appendChild(li);
      });
    });

    socket.on('message', (message) => {
      const li = document.createElement('li');
      li.textContent = message;
      li.setAttribute('data-testid', 'message');
      document.getElementById('chat').appendChild(li);
    });

    window.addEventListener('load', () => {
      if (nickname.value === '') {
        saveUserName.disabled = true;
      } else {
        saveUserName.disabled = false;
      }

      if (chatMessage.value === '') {
        sendChatMessage.disabled = true;
      } else {
        sendChatMessage.disabled = false;
      }
    });
  </script>

</html>
