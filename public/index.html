<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bate-papo Trybol</title>
  </head>

  <body>
    <input type="text" name="" id="username" data-testid="nickname-box">
    <button id="user-save" data-testid="nickname-save">Salvar Apelido</button>
    <h4 id="name"></h4>
    <ul id="chat"></ul>
    <input type="text" name="" id="user-message" data-testid="message-box">
    <button id="send-msg" data-testid="send-button">Enviar</button>
    <div>
      <ul id="online-users"></ul>
    </div>
    <!-- <button id="private-chat-btn" data-testid="private">Chat Privado</button> -->
    <button data-testid="public"> Chat Publico</button>
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io('http://localhost:3000');

    const nicknameInput = document.getElementById('username');
    const saveUserName = document.getElementById('user-save');
    const sendChatMessage = document.getElementById('send-msg');
    const privateChatButton = document.getElementById('private-chat-btn');
    const chatMessage = document.getElementById('user-message');

    let nickname;

    nicknameInput.addEventListener('keyup', () => {
      if (nicknameInput.value === '') {
        saveUserName.disabled = true;
      } else {
        saveUserName.disabled = false;
      }
    });

    chatMessage.addEventListener('keyup', () => {
      if (chatMessage.value === '') {
        sendChatMessage.disabled = true;
      } else {
        sendChatMessage.disabled = false;
      }
    });

    saveUserName.addEventListener('click', () => {
      const name = document.getElementById('name');
      name.textContent = `User: ${nicknameInput.value}`;
      socket.emit('update-nickname', nicknameInput.value);
      nicknameInput.value = '';
      if (nicknameInput.value === '') saveUserName.disabled = true;
      return;
    });

    sendChatMessage.addEventListener('click', () => {
      const nick = document.getElementById('name').textContent.split(' ')[1];
      socket.emit('message', { chatMessage: chatMessage.value, nickname: nick });
      chatMessage.value = '';
      if (chatMessage.value === '') sendChatMessage.disabled = true;
      return;
    });

    // eventos socket.io

    socket.on('connect', () => {
      // quando o usuÃ¡rio conecta sem atualizar seu nickname
      if (!nickname) nickname = `Convidado_${socket.id}`;
      socket.emit('user-connection', nickname)
    });

    socket.on('messages-history', (messagesHistory) => {
      messagesHistory.forEach(({ date, nickname, message }) => {
        const li = document.createElement('li');
        li.textContent = `${date} - ${nickname} => ${message}`;
        li.setAttribute('data-testid', 'message');
        document.getElementById('chat').appendChild(li);
      });
    });

    socket.on('online-users', (data) => {
      Object.entries(data).forEach(([key, value]) => {
        const li = document.createElement('li');
        const userContainer = document.createElement('span');
        if (typeof value === 'object') {
          userContainer.textContent = nickname;
        } else {
          userContainer.textContent = value;
        }
        userContainer.setAttribute('data-testid', 'online-user');
        li.appendChild(userContainer);

        if (key !== socket.id) {
          const privateButton = document.createElement('button');
          privateButton.textContent = 'Chat Privado'
          privateButton.setAttribute('id', key);
          privateButton.setAttribute('data-testid', 'private');
          li.appendChild(privateButton)
          privateButton.addEventListener('click', () => {
            const nickname = document.getElementById('name').textContent.split(' ')[1];
            if (list.childNodes.length === 1) return;
            list.removeChild(list.childNodes[0]);
          });
        }
        document.getElementById('online-users').appendChild(li)
      });
    });

    socket.on('updated-online-list', (data) => {
      document.getElementById('online-users').textContent = '';
      Object.entries(data).forEach(([key, value]) => {
        const li = document.createElement('li');
        const userContainer = document.createElement('span');
        if (typeof value === 'object') {
          userContainer.textContent = nickname;
        } else {
          userContainer.textContent = value;
        }
        userContainer.setAttribute('data-testid', 'online-user');
        li.appendChild(userContainer);

        if (key !== socket.id) {
          const privateButton = document.createElement('button');
          privateButton.textContent = 'Chat Privado'
          privateButton.setAttribute('id', key);
          privateButton.setAttribute('data-testid', 'private');
          li.appendChild(privateButton)
          privateButton.addEventListener('click', () => {
            const nickname = document.getElementById('name').textContent.split(' ')[1];
            if (list.childNodes.length === 1) return;
            list.removeChild(list.childNodes[0]);
          });
        }
        document.getElementById('online-users').appendChild(li)
      });
    });

    socket.on('message', (message) => {
      const li = document.createElement('li');
      li.textContent = message;
      li.setAttribute('data-testid', 'message');
      document.getElementById('chat').appendChild(li);
    });


    window.addEventListener('load', () => {
      if (nicknameInput.value === '') {
        saveUserName.disabled = true;
      } else {
        saveUserName.disabled = false;
      }

      if (chatMessage.value === '') {
        sendChatMessage.disabled = true;
      } else {
        sendChatMessage.disabled = false;
      }
    });
  </script>

</html>
