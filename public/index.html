<!DOCTYPE html>
<html>

<head>
  <title>Web Chat</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src='http://localhost:3000/socket.io/socket.io.js'></script>
</head>

<body>
  <form id="chat">
    <input type=text data-testid="nickname-box" name="usuario" placeholder="Digite seu nome" />
    <button type="button" data-testid="nickname-save">Salvar nome</button>
    <input data-testid="message-box" id="idMessage" name="mensagens" placeholder="Digite sua mensagem" />
    <button type="submit" data-testid="send-button" id="send-buttons">Enviar</button>
    <div id="message"></div>
    <div id="conectado"></div>
  </form>

  <script>
    let socket = io('http://localhost:3000');

    function renderConect(conect) {
      $('#conectado').append('<div data-testid="online-user">'
        + conect +
        '</div>')
    }
    socket.on('conectado', function (conect) {
      renderConect(conect);
    });

    function renderizarMensagem(nickname, chatMessage, newDate) {
      $('#message').append('<div data-testid="message" classe="message">'
        + nickname + ': '
        + chatMessage + ' '
        + newDate +
        '<div/>');
    };

    socket.on('msgRecebida', function (data) {
      const { nickname, chatMessage, newDate } = data;
      console.log(data);
      renderizarMensagem(nickname, chatMessage, newDate);
    });

    socket.on('historico', function (msgDoBanco) {
      const { nickname, chatMessage, novaData } = msgDoBanco;
      renderizarMensagem(nickname, chatMessage, novaData);
    });

    $('#chat').submit(function (e) {
      e.preventDefault();
      let nickname = $('input[name=usuario]').val();
      let chatMessage = $('input[name=mensagens]').val();

      if (nickname.length && chatMessage.length) {
        const ObjMessage = {
          nickname: nickname,
          chatMessage: chatMessage,
        };
        socket.emit('message', { chatMessage, nickname });
      };
      const mensagensId = document.getElementById('idMessage');
      mensagensId.value = '';
    });

  </script>
</body>

</html>