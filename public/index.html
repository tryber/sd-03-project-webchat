<!DOCTYPE html>
<html>

<head>
  <title>Web Chat</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src='http://localhost:3000/socket.io/socket.io.js'></script>
</head>

<body>
  <form id="chat">
    <input type=text data-testid="nickname-box" name="usuario" placeholder="Digite seu nome" />
    <button type="button" data-testid="nickname-save">Salvar nome</button>
    <input data-testid="message-box" id="idMessage" name="mensagens" placeholder="Digite sua mensagem" />
    <button type="submit" data-testid="send-button" id="send-buttons">Enviar</button>
    <div id="message"></div>
  </form>

  <script>
    let socket = io('http://localhost:3000');

    function renderizarMensagem(nickname, chatMessage, novaData) {
      $('#message').append('<div data-testid="message" classe="message">'
        + nickname + ': '
        + chatMessage + ' '
        + novaData +
        '<div/>');
    };

    socket.on('msgRecebida', function (ObjMessage) {
      renderizarMensagem(ObjMessage.nickname, ObjMessage.chatMessage, ObjMessage.novaData);
    });

    socket.on('historico', function (msgDoBanco) {
      const { nickname, chatMessage, novaData } = msgDoBanco;
      renderizarMensagem(nickname, chatMessage, novaData);
    });

    $('#chat').submit(function (e) {
      e.preventDefault();
      let nickname = $('input[name=usuario]').val();
      let chatMessage = $('input[name=mensagens]').val();
      const date = new Date();
      const newDate = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()} `;
      const newHor = `${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`;
      const novaData= `${newDate} ${newHor}`;

      if (nickname.length && chatMessage.length) {

        const ObjMessage = {
          nickname: nickname,
          chatMessage: chatMessage,
          novaData: novaData,
        };

        renderizarMensagem(nickname, chatMessage, novaData);
        socket.emit('message', ObjMessage);
      };
      const mensagensId = document.getElementById('idMessage');
      mensagensId.value = '';
    });
  </script>
</body>

</html>