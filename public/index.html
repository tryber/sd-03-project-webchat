<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
      crossorigin="anonymous"
    />
    <link href="css/sidebar.css" rel="stylesheet" />
  </head>
  <body>
    <nav class="navbar navbar-light bg-light">
      <a class="navbar-brand" href="#"> Web Chat </a>
    </nav>
    <div class="overflow-auto">
      <ul id="messages"></ul>
    </div>
    <div class="form-group position-absolute fixed-bottom w-75">
      <label for="message">Digite sua mensagem:</label>
      <input type="text" class="form-control" id="message" aria-describedby="messageInput" data-testid="message-box" />
      <small id="messageInput" class="form-text text-muted"
        >We'll never share your email with anyone else.</small
      >
      <button type="submit" id="send-button" data-testid="send-button">Enviar</button>
    </div>
    <nav class="bg-light border-right" id="sidebar-wrapper">
      <input type="text" data-testid="nickname-box" id="nickname-box"/>
      <button type="button" data-testid="nickname-save" id="nickname-save">Salvar</button>
      <button type="button" data-testid="public" id="public">Chat p√∫blico</button>
      <div class="list-group list-group-flush" id="usersList">
      </div>
    </nav>
  </body>
  <script
    src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
    crossorigin="anonymous"
  ></script>
  <script>
    const socket = io('http://localhost:3000');
    const sendButton = document.getElementById('send-button');
    let nickname = '';
    let room = 'public';

    sendButton.addEventListener('click', (e) => {
      e.preventDefault();
      let message = document.getElementById('message').value;
      const messageObj = {
        chatMessage: message,
        nickname,
        room,
      };
      socket.emit('message', messageObj);
      message = '';
    });

    const createMessage = (message) => {
      const li = document.createElement('li');
      li.textContent = message;
      li.setAttribute('data-testid', 'message');
      document.getElementById('messages').appendChild(li)
    }

    const public = document.getElementById('public');
    public.addEventListener('click', () => {
      socket.emit('getHistory', room);
      room = 'public';
    });

    const nicknameSave = document.getElementById('nickname-save');
    const nicknameBox = document.getElementById('nickname-box');

    nicknameSave.addEventListener('click', () => {
      socket.emit('changeNickname', nicknameBox.value);
    })

    socket.on('history', (messages) => {
      document.getElementById('messages').innerHTML = '';
      messages.forEach((message) => {
        const [nickname, chatMessage, sentOnDate, sentOnTime, messageRoom] = message.split(',');
        createMessage(`${nickname}: ${chatMessage} - ${sentOnDate} ${sentOnTime}`);
      });
    });

    socket.on('message', (message) => {
      const [nickname, chatMessage, sentOnDate, sentOnTime, messageRoom] = message.split(',');
      if (messageRoom == room) {
        console.log('cheguei aqui')
        createMessage(`${nickname}: ${chatMessage} - ${sentOnDate} ${sentOnTime}`);
      }
    });

    socket.on('getOnlineUsers', (onlineUsers) => {
      document.getElementById('usersList').innerHTML = '';
      const myUser = onlineUsers.find(user => user.id === socket.id);
      nickname = myUser.nickname;
      onlineUsers.forEach((onlineUser) => {
        const button = document.createElement('button');
        button.type="button";
        button.classList="list-group-item list-group-item-action bg-light"
        button.setAttribute('data-testid', 'private');
        const span = document.createElement('span');
        span.setAttribute('data-testid', 'online-user');
        button.appendChild(span);
        span.textContent=onlineUser.nickname;
        if (onlineUser.nickname === nickname) button.disabled = true;
        button.addEventListener('click', () => {
          const friendId = onlineUser.id.split('').reduce((acc, word) => acc + parseInt(word.charCodeAt(0)), 0);
          const myId = myUser.id.split('').reduce((acc, word) => acc + parseInt(word.charCodeAt(0)), 0);
          room = friendId + myId;
          socket.emit('changeChat', room);
        });
        document.getElementById('usersList').appendChild(button);
      });
    });
  </script>
</html>
