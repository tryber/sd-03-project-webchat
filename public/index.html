<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bate-papo Trybol</title>
  </head>

  <body>
    <div>
      <h4 id="name"></h4>
    </div>
    <div>
      <input type="text" name="" id="username" data-testid="nickname-box">
      <button id="user-save" data-testid="nickname-save">Salvar Apelido</button>
    </div>
    <div>
      <input type="text" name="" id="user-message" data-testid="message-box">
      <button id="send-msg" data-testid="send-button">Enviar</button>
    </div>
    <div id="public-chat-container">
      <ul id="chat"></ul>
    </div>
    <div id="private-chat-container" hidden>
      <ul id="private-chat"></ul>
    </div>
    <div>
      <ul id="online-users"></ul>
    </div>
    <div>
      <button data-testid="public" id="public-chat-btn" disabled> Chat Publico</button>
    </div>
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io('http://localhost:3000');

    const nicknameInput = document.getElementById('username');
    const saveUserName = document.getElementById('user-save');
    const sendChatMessage = document.getElementById('send-msg');
    const chatMessage = document.getElementById('user-message');
    const publicChatButton = document.getElementById('public-chat-btn');

    let nickname;
    let receiver;

    nicknameInput.addEventListener('keyup', () => {
      if (nicknameInput.value === '') {
        saveUserName.disabled = true;
      } else {
        saveUserName.disabled = false;
      }
    });

    chatMessage.addEventListener('keyup', () => {
      if (chatMessage.value === '') {
        sendChatMessage.disabled = true;
      } else {
        sendChatMessage.disabled = false;
      }
    });

    saveUserName.addEventListener('click', () => {
      const name = document.getElementById('name');
      name.textContent = `User: ${nicknameInput.value}`;
      socket.emit('update-nickname', nicknameInput.value);
      nicknameInput.value = '';
      if (nicknameInput.value === '') saveUserName.disabled = true;
      return;
    });

    sendChatMessage.addEventListener('click', () => {
      const nick = document.getElementById('name').textContent.split(' ')[1];
      socket.emit('message', { chatMessage: chatMessage.value, nickname: nick, receiver });
      chatMessage.value = '';
      if (chatMessage.value === '') sendChatMessage.disabled = true;
      return;
    });

    publicChatButton.addEventListener('click', () => {
      const publicChat = document.getElementById('public-chat-container');
      const privateChat = document.getElementById('private-chat-container');
      const privateChatButtons = document.querySelectorAll('button.private-btn');
      receiver = undefined;
      publicChat.removeAttribute('hidden');
      privateChat.setAttribute('hidden', true);
      publicChatButton.disabled = true;
      [...privateChatButtons].map((button) => button.disabled = false);
      return;
    })

    // função para criar botão de chat privado
    const privateChatButton = (key) => {
      const privateButton = document.createElement('button');
      privateButton.textContent = 'Chat Privado'
      privateButton.id = key;
      privateButton.setAttribute('data-testid', 'private');
      privateButton.setAttribute('class', 'private-btn');
      privateButton.addEventListener('click', () => {
        const publicChat = document.getElementById('public-chat-container');
        const privateChat = document.getElementById('private-chat-container');
        receiver = key;
        publicChat.setAttribute('hidden', true);
        privateChat.removeAttribute('hidden');
        publicChatButton.disabled = false;
        privateButton.disabled = true;
        return;
      });
      return privateButton;
    }
    // eventos socket.io

    socket.on('connect', () => {
      // quando o usuário conecta sem atualizar seu nickname
      if (!nickname) nickname = `Convidado_${socket.id}`;
      socket.emit('user-connection', nickname)
      const name = document.getElementById('name');
      name.textContent = `User: ${nickname}`;
    });

    socket.on('messages-history', (messagesHistory) => {
      messagesHistory.forEach(({ date, nickname, message }) => {
        const li = document.createElement('li');
        li.textContent = `${date} - ${nickname} => ${message}`;
        li.setAttribute('data-testid', 'message');
        document.getElementById('chat').appendChild(li);
      });
    });

    socket.on('online-users', (data) => {
      const onlineUsers = document.getElementById('online-users');
      onlineUsers.textContent = '';
      Object.entries(data).forEach(([key, value]) => {
        const li = document.createElement('li');
        const userContainer = document.createElement('p');
        if (typeof value === 'object') {
          userContainer.textContent = nickname;
        } else {
          userContainer.textContent = value;
        }
        userContainer.setAttribute('data-testid', 'online-user');
        li.appendChild(userContainer);

        if (key !== socket.id) {
          const privateButton = privateChatButton(key);
          li.appendChild(privateButton)
        }
        onlineUsers.appendChild(li)
      });
    });

    socket.on('message', (message, receiver, nickname) => {
      if (!receiver && !nickname) {
        const li = document.createElement('li');
        li.textContent = message;
        li.setAttribute('data-testid', 'message');
        document.getElementById('chat').appendChild(li);
      } else {
        const li = document.createElement('li');
        li.textContent = message;
        li.setAttribute('data-testid', 'message');
        document.getElementById('private-chat').appendChild(li);
      }
    });


    window.addEventListener('load', () => {
      if (nicknameInput.value === '') {
        saveUserName.disabled = true;
      } else {
        saveUserName.disabled = false;
      }

      if (chatMessage.value === '') {
        sendChatMessage.disabled = true;
      } else {
        sendChatMessage.disabled = false;
      }
    });
  </script>

</html>
