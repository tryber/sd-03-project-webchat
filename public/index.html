<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebChat</title>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  </head>
  <body>
    <ul id="messagens"></ul>
    <ul id="online"></ul>
    <form>
      <input
        data-testid="message-box"
        type="text"
        id="messageInput"
        name="message-input"
      />
      <button data-testid="send-button" type="submit" id="submit">
        Enviar
      </button>

      <input
        data-testid="nickname-box"
        id="newNick"
        type="text"
        autocomplete="off"
      />
      <button data-testid="nickname-save" type="submit" id="submitNick">
        Change Name
      </button>
    </form>
    <script>
      window.onload = () => {
        const submitMsg = document.getElementById("submit");
        const newNick = document.getElementById("newNick");
        const submitNewNick = document.getElementById("submitNick");
        const socket = io();

        socket.on("message", (data) => {
          const li = document.createElement("li");
          li.id = "list-of-messages";
          li.setAttribute("data-testid", "message");
          li.textContent = data;
          document.getElementById("messagens").appendChild(li);
        });

        const getRandomName = () => `User ${Math.ceil(Math.random() * 100)}`;
        

        submitMsg.addEventListener("click", (e) => {
          e.preventDefault();
          const message = document.getElementById("messageInput").value;
          const nickInput = document.getElementById("newNick").value;
          const nickname = nickInput.length ? nickInput : getRandomName();
          socket.emit("message", { chatMessage: message, nickname });
          message.value = "";
        });

        submitNewNick.addEventListener("click", (e) => {
          e.preventDefault();
          const nickInput = document.getElementById("newNick").value;
          const nickname = nickInput.length ? nickInput : getRandomName();
          socket.emit("changeName", { newNickName });
          newNick.value = "";
        });

        socket.on("history", (msg) => {
          const li = document.createElement("li");
          li.id = "list-of-messages";
          li.setAttribute("data-testid", "message");
          li.textContent = `${msg}`;
          document.getElementById("messagens").appendChild(li);
        });

        socket.on('online', (data) => {
          data.forEach((user) => {
            const li = document.createElement("li");
            li.setAttribute("data-testid", "online-user");
            li.textContent = data;
            document.getElementById('online').appendChild(user)
          });
        });
      };
    </script>
  </body>
</html>
